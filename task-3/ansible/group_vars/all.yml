---
# PostgreSQL HA Cluster Configuration for Student 5
# Based on autobase/postgresql_cluster

############################################################
# Main cluster variables
############################################################

patroni_cluster_name: "student5-postgres-cluster"

# Superuser credentials
patroni_superuser_username: "postgres"
patroni_superuser_password: "SecurePass123!"

# Replication user credentials
patroni_replication_username: "replicator"
patroni_replication_password: "ReplicaPass123!"

# Synchronous replication (optional, disabled for simplicity)
synchronous_mode: false
synchronous_mode_strict: false
synchronous_node_count: 1

# HAProxy Load Balancing - ENABLED
with_haproxy_load_balancing: true
haproxy_listen_port:
  master: 5000      # Read/Write port (master)
  replicas: 5001    # Read-only port (all replicas)
  replicas_sync: 5002
  replicas_async: 5003
  stats: 7000       # HAProxy stats page

haproxy_maxconn:
  global: 100000
  master: 10000
  replica: 10000

haproxy_timeout:
  client: "60m"
  server: "60m"

# TLS - Disabled for lab environment (enable in production!)
tls_cert_generate: false

############################################################
# DCS (Distributed Consensus Store) - etcd
############################################################

dcs_type: "etcd"
dcs_exists: false  # Let autobase deploy and manage etcd

# etcd configuration
etcd_version: "3.5.23"
etcd_conf_dir: "/etc/etcd"
etcd_data_dir: "/var/lib/etcd"
etcd_cluster_name: "etcd-{{ patroni_cluster_name }}"
etcd_tls_enable: false  # Disabled for lab environment

############################################################
# PostgreSQL parameters
############################################################

postgresql_version: 16  # Using PostgreSQL 16 for stability
postgresql_data_dir: "/var/lib/postgresql/{{ postgresql_version }}/main"
postgresql_port: 5432

# Connection pooling with PgBouncer (optional, can enable if needed)
pgbouncer_install: false

############################################################
# Patroni configuration
############################################################

patroni_install_version: "latest"
patroni_restapi_port: 8008
patroni_ttl: 30
patroni_loop_wait: 10
patroni_retry_timeout: 10
patroni_maximum_lag_on_replica: 1048576  # 1MB

############################################################
# System and package settings
############################################################

# Disable system checks for lab environment
disable_os_checks: true

# Package installation method
patroni_installation_method: "deb"  # Installing from deb package to avoid Python version conflicts
postgresql_packages:
  - "postgresql-{{ postgresql_version }}"
  - "postgresql-client-{{ postgresql_version }}"

# Enable automatic PostgreSQL service restart on failure
postgresql_service_restart_on_failure: true

############################################################
# Firewall (disabled for lab environment)
############################################################

firewall_enable: false
firewall_allow_tcp_ports:
  - "{{ postgresql_port }}"
  - "{{ patroni_restapi_port }}"
  - "2379"  # etcd client
  - "2380"  # etcd peer
  - "5000"  # HAProxy master
  - "5001"  # HAProxy replicas
  - "7000"  # HAProxy stats

############################################################
# Additional settings
############################################################

# Timezone
timezone: "UTC"

# Locale
locale: "en_US.UTF-8"

# Kernel tuning (optional, disabled for simplicity)
sysctl_conf: {}

# Disable pgBackRest and WAL-G backups for this lab
pgbackrest_install: false
wal_g_install: false

# Cloud provider (none for our case)
cloud_provider: ""
