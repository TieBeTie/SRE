## 1. –û—Ç —á–µ–≥–æ –∑–∞–≤–∏—Å–∏—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã TSC? –ß—Ç–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç
—Å–æ–±–æ–π —á–∞—Å—Ç–æ—Ç–∞ TSC? –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏–ª–∏ –Ω–µ—Ç? –ö–∞–∫ —Å–≤—è–∑–∞–Ω—ã TSC
–Ω–∞ —Ä–∞–∑–Ω—ã—Ö —è–¥—Ä–∞—Ö? –î–ª—è —á–µ–≥–æ TSC –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö? –ß—Ç–æ
–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —á—Ç–æ–±—ã —Å –ø–æ–º–æ—â—å—é TSC –º–æ–∂–Ω–æ –±—ã–ª–æ –∏–∑–º–µ—Ä—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
–∫–æ–¥–∞?

### 1. –û—Ç —á–µ–≥–æ –∑–∞–≤–∏—Å–∏—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã TSC?

–ü–æ —Ç–µ–∫—Å—Ç—É:

TSC –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –¥–≤—É—Ö —Ä–µ–∂–∏–º–∞—Ö:

variable-rate TSC ‚Äî —á–∞—Å—Ç–æ—Ç–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏—è = —Ç–µ–∫—É—â–∞—è —á–∞—Å—Ç–æ—Ç–∞ —è–¥—Ä–∞
(Pentium M, Pentium 4 —Å—Ç–∞—Ä—ã—Ö –º–æ–¥–µ–ª–µ–π, P6 family)

‚Äúthe time-stamp counter increments with every internal processor clock cycle...
Intel SpeedStep transitions may also impact the processor clock.‚Äù

–¢–æ –µ—Å—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–∑–º–µ–Ω—è–µ–º–æ–π —á–∞—Å—Ç–æ—Ç—ã CPU (P-States, Turbo, SpeedStep).

constant-rate TSC / invariant TSC ‚Äî —á–∞—Å—Ç–æ—Ç–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è

‚Äúthe time-stamp counter increments at a constant rate...
Constant TSC behavior ensures that the duration of each clock tick is uniform‚Ä¶‚Äù

–¢–æ—á–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –æ–ø–æ—Ä–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞ (ART), –∞ –Ω–µ –æ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏/—á–∞—Å—Ç–æ—Ç—ã CPU.

–ü–æ—ç—Ç–æ–º—É:
üëâ —Ç–æ—á–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:

–µ—Å—Ç—å –ª–∏ Invariant TSC

–∫–∞–∫ –∫–∞–ª–∏–±—Ä—É–µ—à—å —á–∞—Å—Ç–æ—Ç—É (CPUID leaf 0x15)

—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∫—Ä–∏—Å—Ç–∞–ª—å–Ω–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ (core crystal clock)

‚ùì 2. –ß—Ç–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —á–∞—Å—Ç–æ—Ç–∞ TSC?

–ß–∞—Å—Ç–æ—Ç–∞ TSC ‚Äî —ç—Ç–æ —Å–∫–æ—Ä–æ—Å—Ç—å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ —Å—á—ë—Ç—á–∏–∫–∞ TSC, ticks per second.

–ï—Å–ª–∏ TSC invariant:

‚Äúinvariant TSC will run at a constant rate in all P-, C-, T-states.‚Äù

–û–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è:

TSC_frequency = ART_frequency * (EBX / EAX)   from CPUID leaf 0x15


–ï—Å–ª–∏ TSC variable-rate ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—É—â–∞—è —á–∞—Å—Ç–æ—Ç–∞ —è–¥—Ä–∞.

‚ùì 3. –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ —á–∞—Å—Ç–æ—Ç–∞ TSC –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏–ª–∏ –Ω–µ—Ç?

SDM –¥–∞—ë—Ç –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π:

‚úî –ï—Å–ª–∏ CPUID.80000007H:EDX = 1 ‚Üí TSC invariant

–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞.

‚úî –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí TSC variable-rate

–ó–∞–≤–∏—Å–∏—Ç –æ—Ç —á–∞—Å—Ç–æ—Ç—ã CPU, –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ Turbo/SpeedStep.

–¢–æ –µ—Å—Ç—å –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö Intel –≤—Å–µ–≥–¥–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è.

‚ùì 4. –ö–∞–∫ —Å–≤—è–∑–∞–Ω—ã TSC –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —è–¥—Ä–∞—Ö?

SDM –≥–æ–≤–æ—Ä–∏—Ç:

IA32_TSC_AUX + RDTSCP can detect CPU migration and adjust for per-CPU differences.
IA32_TSC_ADJUST allows software to synchronize TSC across cores.

–ê —Ç–∞–∫–∂–µ:

‚ÄúSoftware seeking to synchronize TSC must perform writes on each logical processor‚Ä¶‚Äù

–¢–æ –µ—Å—Ç—å:

–∑–Ω–∞—á–µ–Ω–∏—è TSC –º–æ–≥—É—Ç –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –º–µ–∂–¥—É —è–¥—Ä–∞–º–∏ –ø–æ—Å–ª–µ boot/reset

–Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä—è invariant TSC:

—á–∞—Å—Ç–æ—Ç–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è

–¥—Ä–µ–π—Ñ–∞ –Ω–µ—Ç

—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞ —á–µ—Ä–µ–∑ WRMSR IA32_TSC_ADJUST

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—Å–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ Intel –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ü–∏–∫–ª–æ–≤, –Ω–æ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ SDM –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ—Å—Ç—å per-core.

‚ùì 5. –î–ª—è —á–µ–≥–æ TSC –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö?

–ò–∑ —Ç–µ–∫—Å—Ç–∞:

‚ÄúOS may use the TSC for wall clock timer services (instead of ACPI or HPET).
TSC reads are much more efficient‚Ä¶‚Äù

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- –≤—ã—Å–æ–∫–æ—Ç–æ—á–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞ (wall clock)
- –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- latency measurements
- synchronization
- scheduling (detect CPU migration)
- –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –≤ —è–¥—Ä–µ
- KVM/VMCS timekeeping

‚ùì 6. –ß—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —á—Ç–æ–±—ã —Å –ø–æ–º–æ—â—å—é TSC –º–æ–∂–Ω–æ –±—ã–ª–æ –∏–∑–º–µ—Ä—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞?

–ü–æ —Ç–µ–∫—Å—Ç—É –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- Invariant TSC ‚Üí —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RDTSCP (ordered), –∞ –Ω–µ RDTSC
- RDTSC –Ω–µ —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω ‚Üí –¥–∞—ë—Ç —à—É–º
- –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ–∫—Ä—É–≥ RDTSC:
- LFENCE; RDTSC
- –∏–ª–∏ CPUID; RDTSC
- –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–º —è–¥—Ä–µ
- –û—Ç–∫–ª—é—á–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (pin thread)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CPUID leaf 0x15 ‚Üí —Ç–æ—á–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ TSC

## 2. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ–± ACPI –∏ DeviceTree. –ß–µ–º –æ–Ω–∏ –ø–æ—Ö–æ–∂–∏ –∏ –≤ —á–µ–º –æ—Ç–ª–∏—á–∞—é—Ç—Å—è?
–ö–∞–∫–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –æ–Ω–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –∏ –æ—Ç–∫—É–¥–∞ —ç—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
–±–µ—Ä—É—Ç—Å—è?

### 2. ACPI vs Device Tree ‚Äî –∫–∞–∫–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–∫—É–¥–∞ –æ–Ω–∏ –±–µ—Ä—É—Ç—Å—è
üîπ –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç ACPI

–í ACPI –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö ‚Äî data tables –∏ definition blocks. ‚ÄúThese data structures are the primary communication mechanism between the firmware and the OS.‚Äù 

¬´Definition blocks¬ª —Å–æ–¥–µ—Ä–∂–∞—Ç –±–∞–π—Ç‚Äë–∫–æ–¥ –Ω–∞ —è–∑—ã–∫–µ ACPI Machine Language (AML), –∫–æ—Ç–æ—Ä—ã–π –û–° –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç. 

–ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –û–° –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ definition blocks –∏–∑ —Ç–∞–±–ª–∏—Ü ACPI (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ —Ç–∞–±–ª–∏—Ü –≤—Ä–æ–¥–µ DSDT, SSDT –∏ –¥—Ä.) –∏ —Å—Ç—Ä–æ–∏—Ç –∏–∑ –Ω–∏—Ö ¬´namespace¬ª ‚Äî –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é –¥—Ä–µ–≤–æ–≤–∏–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (—É—Å—Ç—Ä–æ–π—Å—Ç–≤, –º–µ—Ç–æ–¥–æ–≤, —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ —Ç.‚ÄØ–¥.). ¬´ACPI Namespace ‚Äî a hierarchical tree structure ‚Ä¶ that contains named objects.¬ª 

–ò—Å—Ç–æ—á–Ω–∏–∫ —ç—Ç–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä ‚Äî –ø—Ä–æ—à–∏–≤–∫–∞ (firmware, BIOS/UEFI), –∫–æ—Ç–æ—Ä–∞—è —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç ACPI‚Äë—Ç–∞–±–ª–∏—Ü—ã (RSDP ‚Üí XSDT/RSDT ‚Üí —Ç–∞–±–ª–∏—Ü—ã –≤—Ä–æ–¥–µ FADT, DSDT, SSDT –∏ –¥—Ä.). 

–ò–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ ‚Äî ACPI –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –û–° –ø–æ–ª–Ω—É—é –º–æ–¥–µ–ª—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã: –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤, —à–∏–Ω—ã, —Ä–µ—Å—É—Ä—Å–æ–≤ (–∞–¥—Ä–µ—Å–∞, IRQ, –ø–∞–º—è—Ç—å), ‚Äî + –∫–æ–¥ (–º–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, power / plug‚Äëand‚Äëplay / –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è), —É–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–π –∫–∞–∫ AML‚Äë–±–ª–æ–∫–∏.

üîπ –ü–æ—á–µ–º—É —ç—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç Device Tree

Device Tree ‚Äî —ç—Ç–æ, –ø–æ —Å—É—Ç–∏, —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –µ—ë —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∞–¥—Ä–µ—Å–∞, –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∏ —Ç.–ø., –±–µ–∑ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ –∫–æ–¥–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. 

–û–±—ã—á–Ω–æ –æ–Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—à–∏–≤–∫–æ–π –∏–ª–∏ bootloader‚Äë–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, DTB‚Äë—Ñ–∞–π–ª) –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, —è–¥—Ä–æ –µ—ë –ø–∞—Ä—Å–∏—Ç –∏ —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ—Ç ¬´–¥–µ—Ä–µ–≤–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤¬ª. 

–í ACPI –∂–µ ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å: definition blocks + AML + namespace, —á—Ç–æ –¥–∞—ë—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å runtime‚Äë–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, power‚Äë/thermal‚Äë–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞, plug‚Äëand‚Äëplay, –≥–æ—Ä—è—á–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤, —á–µ–≥–æ –Ω–µ—Ç –≤ –ø—Ä–æ—Å—Ç–æ–º Device Tree. 

üîπ –ö—Ä–∞—Ç–∫–æ: —Å—Ö–æ–¥—Å—Ç–≤–∞ –∏ –æ—Ç–ª–∏—á–∏—è

–°—Ö–æ–¥—Å—Ç–≤–æ: –∏ ACPI, –∏ Device Tree –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –û–° –æ–ø–∏—Å–∞–Ω–∏–µ –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã ‚Äî –∫–∞–∫–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –µ—Å—Ç—å, —Ä–µ—Å—É—Ä—Å—ã, —à–∏–Ω—ã, –∞–¥—Ä–µ—Å–∞.

–û—Ç–ª–∏—á–∏–µ: ACPI ‚Äî –±–æ–≥–∞—Ç–∞—è —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è –º–æ–¥–µ–ª—å —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ + –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º –∫–æ–¥–æ–º (AML), –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º, plug‚Äëand‚Äëplay –∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏; Device Tree ‚Äî –ø—Ä–æ—Å—Ç–æ–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ —Ä–µ—Å—É—Ä—Å–æ–≤, –±–µ–∑ –ª–æ–≥–∏–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.


## 3. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø–∏—Ç–∞–Ω–∏–µ–º –≤ ACPI. –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ? –ö–∞–∫–∏–µ —Ä–µ–∂–∏–º—ã
—Ä–∞–±–æ—Ç—ã –≤—ã –∑–Ω–∞–µ—Ç–µ? –ß–µ–º –æ—Ç–ª–∏—á–∞—é—Ç—Å—è S3 –æ—Ç S4? –ß—Ç–æ —Ç–∞–∫–æ–µ S0ix? 
### 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏–µ–º –≤ ACPI ‚Äî —á—Ç–æ —ç—Ç–æ, —Å–æ—Å—Ç–æ—è–Ω–∏—è, S3 vs S4, S0ix
üîπ –ß—Ç–æ —Ç–∞–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏–µ–º –≤ ACPI

ACPI ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–µ–∂–¥—É firmware –∏ –û–°, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –û–° –±—Ä–∞—Ç—å –Ω–∞ —Å–µ–±—è –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø–∏—Ç–∞–Ω–∏–µ–º. –ß–µ—Ä–µ–∑ ACPI –û–° –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å —Å–∏—Å—Ç–µ–º—É, –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–ª–∏—Ç–∏–∫–∏. 

ACPI –æ–ø–∏—Å—ã–≤–∞–µ—Ç power‚Äë–º–µ—Ö–∞–Ω–∏–∑–º—ã –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Ä–æ–≤–Ω—è—Ö: system power management (–≤—Å—è —Å–∏—Å—Ç–µ–º–∞), device power management (–æ—Ç–¥–µ–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞), processor power management (CPU), performance/power states, thermal, plug & play –∏ –¥—Ä. 

üîπ –ö–∞–∫–∏–µ —Ä–µ–∂–∏–º—ã/—Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç

–í —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã (G‚Äëstates / S‚Äëstates), —Å–æ—Å—Ç–æ—è–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (D‚Äëstates), —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ (C‚Äëstates) –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (P‚Äëstates). 

–î–ª—è —Å–∏—Å—Ç–µ–º—ã, –æ—Å–Ω–æ–≤–Ω—ã–µ S‚Äë—Å–æ—Å—Ç–æ—è–Ω–∏—è: S0..S5. 

- S0 (G0) ‚Äî —Ä–∞–±–æ—á–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞. 
- S1, S2 ‚Äî –ª—ë–≥–∫–∏–µ —Å–ø—è—â–∏–µ/–ø–æ–Ω–∏–∂–µ–Ω–Ω—ã–µ —Ä–µ–∂–∏–º—ã (CPU –º–æ–∂–µ—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è, –Ω–æ –ø–∞–º—è—Ç—å/—Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–≥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è). 
- S3 ‚Äî ‚ÄúSuspend to RAM‚Äù (—Å–ø—è—â–∏–π —Ä–µ–∂–∏–º / standby): –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø–∏—Ç–∞–Ω–∏–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤—ã–∫–ª—é—á–µ–Ω–æ, –ø—Ä–∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è. 
- S4 ‚Äî ‚ÄúHibernate / Suspend to Disk‚Äù: —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ RAM —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫, –ø–∏—Ç–∞–Ω–∏–µ –ø–æ—á—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–µ–Ω–æ; –ø—Ä–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –¥–∏—Å–∫–∞. 
- S5 ‚Äî Soft Off (–ø–æ–ª–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ, –∫–∞–∫ shutdown). 
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ, –µ—Å—Ç—å S0ix (–∏–Ω–æ–≥–¥–∞ –Ω–∞–∑—ã–≤–∞–µ–º—ã–π Modern Standby / Low Power Idle): —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞—ë—Ç—Å—è ¬´–≤–∫–ª—é—á—ë–Ω–Ω–æ–π¬ª (S0), –Ω–æ —á–∞—Å—Ç—å –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤ —É—Ö–æ–¥–∏—Ç –≤ idle / low‚Äëpower —Ä–µ–∂–∏–º, —á—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –±—ã—Å—Ç—Ä–æ ¬´–ø—Ä–æ—Å–Ω—É—Ç—å—Å—è¬ª. 

üîπ –ß–µ–º –æ—Ç–ª–∏—á–∞—é—Ç—Å—è S3, S4, S0ix

S3 ‚Äî Sleep / Suspend to RAM: RAM –æ—Å—Ç–∞—ë—Ç—Å—è –ø–æ–¥ –ø–∏—Ç–∞–Ω–∏–µ–º, –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–ø–∏—Ç; –≤—ã—Ö–æ–¥ –∏–∑ S3 ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä—ã–π. –£–¥–æ–±–µ–Ω, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–∞–±–æ—Ç–µ.

S4 ‚Äî Hibernate / Suspend to Disk: RAM –≤—ã–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫, –ø–∏—Ç–∞–Ω–∏–µ –ø–æ—á—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –Ω–æ –≤–æ–∑–≤—Ä–∞—Ç —Ç—Ä–µ–±—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å –¥–∏—Å–∫–∞ (–º–µ–¥–ª–µ–Ω–Ω—ã–π).

S0ix ‚Äî Low‚Äëpower idle –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ: –Ω–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π ‚Äú—Å–æ–Ω‚Äù, –Ω–æ —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–æ—Å—Ç–æ–µ –û–°, —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è –∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ –¥–∏—Å–∫/RAM‚Äë–ø–∏—Ç–∞–Ω–∏–µ.

# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ5: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HPET –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

## –û–±–∑–æ—Ä

–í –¥–∞–Ω–Ω–æ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∞–π–º–µ—Ä–∞ HPET (High Precision Event Timer) –¥–ª—è –∑–∞–º–µ–Ω—ã RTC –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ –∑–∞–¥–∞—á, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞ –ø–∞–º—è—Ç–∏ —Å –ø–æ–º–æ—â—å—é —Å–ø–∏–Ω–ª–æ–∫–æ–≤, –∞ —Ç–∞–∫–∂–µ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ TSC (Time Stamp Counter).

---

## –ó–∞–¥–∞–Ω–∏–µ ‚Ññ1: –î–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–∞–º ACPI (RSDP/RSDT/XSDT/FADT/HPET)

### –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ HPET –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–∞–º ACPI (Advanced Configuration and Power Interface). –°–∏—Å—Ç–µ–º–∞ ACPI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–∏—Å—Ç–µ–º—ã. –ö–æ—Ä–Ω–µ–≤–æ–π —É–∫–∞–∑–∞—Ç–µ–ª—å RSDP (Root System Description Pointer) —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–¥—Ä–µ—Å–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ —Ç–∞–±–ª–∏—Ü RSDT (32-–±–∏—Ç–Ω—ã–µ –∞–¥—Ä–µ—Å–∞) –∏–ª–∏ XSDT (64-–±–∏—Ç–Ω—ã–µ –∞–¥—Ä–µ—Å–∞), –∫–æ—Ç–æ—Ä—ã–µ –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å —Å–æ–¥–µ—Ä–∂–∞—Ç —É–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, —Ç–∞–∫–∏–µ –∫–∞–∫ FADT (Fixed ACPI Description Table) –∏ HPET.

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª—ã:** `kern/timer.c`, `kern/timer.h`

**–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **`get_rsdp()`** ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è RSDP
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–¥—Ä–µ—Å –∏–∑ `uefi_lp->ACPIRoot`, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–º
   - –ú–∞–ø–ø–∏—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å RSDP –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —è–¥—Ä–∞ —á–µ—Ä–µ–∑ `mmio_map_region`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É RSDP

2. **`find_acpi_table(const char *sign)`** ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ ACPI —Ç–∞–±–ª–∏—Ü—ã –ø–æ —Å–∏–≥–Ω–∞—Ç—É—Ä–µ
   - –ü–æ–ª—É—á–∞–µ—Ç RSDP —á–µ—Ä–µ–∑ `get_rsdp()`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∏–≥–Ω–∞—Ç—É—Ä—É RSDP ("RSD PTR ")
   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ XSDT (–ø—Ä–∏ Revision >= 2) –∏–ª–∏ RSDT (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
   - –ü–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –º–∞—Å—Å–∏–≤ –∞–¥—Ä–µ—Å–æ–≤ —Ç–∞–±–ª–∏—Ü –≤ RSDT/XSDT
   - –î–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã:
     - –ú–∞–ø–ø–∏—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã (ACPISDTHeader) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã
     - –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å–∏–≥–Ω–∞—Ç—É—Ä—É —Å –∏—Å–∫–æ–º–æ–π (4 –±–∞–π—Ç–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä "HPET", "FACP")
     - –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –º–∞–ø–ø–∏—Ç –≤—Å—é —Ç–∞–±–ª–∏—Ü—É —á–µ—Ä–µ–∑ `mmio_remap_last_region` (–∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–ª–µ Length –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
     - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É (—Å—É–º–º–∞ –≤—Å–µ—Ö –±–∞–π—Ç–æ–≤ —Ç–∞–±–ª–∏—Ü—ã –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–≤–Ω–∞ –Ω—É–ª—é)
     - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É

3. **`get_fadt()`** ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã FADT
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `find_acpi_table("FACP")` (—Å–∏–≥–Ω–∞—Ç—É—Ä–∞ FADT ‚Äî "FACP", –∞ –Ω–µ "FADT")
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É FADT

4. **`get_hpet()`** ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã HPET
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `find_acpi_table("HPET")`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É HPET, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ HPET

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç XSDT –Ω–∞–¥ RSDT: —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ ACPI, –µ—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç XSDT (Revision >= 2), –µ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–º–µ—Å—Ç–æ RSDT
- –î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥: —Å–Ω–∞—á–∞–ª–∞ –º–∞–ø–ø–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã, –∑–∞—Ç–µ–º –≤—Å—è —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—è Length
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã

---

## –ó–∞–¥–∞–Ω–∏–µ ‚Ññ2: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HPET —Ç–∞–π–º–µ—Ä–æ–≤ hpet0/hpet1 –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å IDT

### –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

HPET (High Precision Event Timer) –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π. –í –¥–∞–Ω–Ω–æ–º –∑–∞–¥–∞–Ω–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–≤—É—Ö —Ç–∞–π–º–µ—Ä–æ–≤ HPET (hpet0 –∏ hpet1) —Å –ø–µ—Ä–∏–æ–¥–∞–º–∏ 0.5 –∏ 1.5 —Å–µ–∫—É–Ω–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ. –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∂–∏–º LegacyReplacement, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –Ω–∞ –ª–∏–Ω–∏–∏ IRQ0 (–¥–ª—è hpet0) –∏ IRQ8 (–¥–ª—è hpet1), –∑–∞–º–µ–Ω—è—è PIT –∏ RTC —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª—ã:** `kern/timer.c`, `kern/timer.h`, `kern/trap.c`, `kern/trapentry.S`

**–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **`hpet_init()`** ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HPET
   - –ü–æ–ª—É—á–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É HPET —á–µ—Ä–µ–∑ `get_hpet()`
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ HPET –∏–∑ –ø–æ–ª—è `address.address`
   - –ú–∞–ø–ø–∏—Ç —Ä–µ–≥–∏—Å—Ç—Ä—ã HPET –≤ –ø–∞–º—è—Ç—å —á–µ—Ä–µ–∑ `mmio_map_region`
   - –ß–∏—Ç–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä GCAP_ID –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ —Å—á–µ—Ç—á–∏–∫–∞ –≤ —Ñ–µ–º—Ç–æ—Å–µ–∫—É–Ω–¥–∞—Ö
   - –í—ã—á–∏—Å–ª—è–µ—Ç —á–∞—Å—Ç–æ—Ç—É HPET: `hpetFreq = 1 Peta / hpetFemto`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É LegacyReplacement —Ä–µ–∂–∏–º–∞ (–±–∏—Ç HPET_LEG_RT_CAP)
   - –í–∫–ª—é—á–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ HPET (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –±–∏—Ç HPET_ENABLE_CNF –≤ GEN_CONF)

2. **`hpet_enable_interrupts_tim0()`** ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–µ—Ä–∞ 0 (hpet0)
   - –í—ã–∑—ã–≤–∞–µ—Ç `hpet_init()` –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)
   - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç HPET_ENABLE_CNF) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–µ—Ä–µ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
   - –í–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º LegacyReplacement (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç HPET_LEG_RT_CNF –≤ GEN_CONF)
   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç TIM0_CONF:
     - –í–∫–ª—é—á–∞–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (HPET_TN_INT_ENB_CNF)
     - –í–∫–ª—é—á–∞–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º (HPET_TN_TYPE_CNF)
     - –í–∫–ª—é—á–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É –∑–Ω–∞—á–µ–Ω–∏—è (HPET_TN_VAL_SET_CNF) –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞—Ä–∞—Ç–æ—Ä–∞
   - –í—ã—á–∏—Å–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–º–ø–∞—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞ 0.5 —Å–µ–∫—É–Ω–¥—ã: `delta = hpetFreq / 2`
   - –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –≤ 0
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç TIM0_COMP –≤ –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ delta
   - –í–∫–ª—é—á–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –æ–±—Ä–∞—Ç–Ω–æ
   - –†–∞–∑–º–∞—Å–∫–∏—Ä—É–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ IRQ_TIMER –≤ PIC —á–µ—Ä–µ–∑ `pic_irq_unmask(IRQ_TIMER)`

3. **`hpet_enable_interrupts_tim1()`** ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–µ—Ä–∞ 1 (hpet1)
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ hpet0, –Ω–æ:
     - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç TIM1_CONF –≤–º–µ—Å—Ç–æ TIM0_CONF
     - –ü–µ—Ä–∏–æ–¥ 1.5 —Å–µ–∫—É–Ω–¥—ã: `delta = (hpetFreq * 3) / 2`
     - –†–∞–∑–º–∞—Å–∫–∏—Ä—É–µ—Ç IRQ_CLOCK –≤–º–µ—Å—Ç–æ IRQ_TIMER

4. **`hpet_handle_interrupts_tim0()`** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –æ—Ç hpet0
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏–≥–Ω–∞–ª EOI (End of Interrupt) –≤ PIC –¥–ª—è IRQ_TIMER —á–µ—Ä–µ–∑ `pic_send_eoi(IRQ_TIMER)`

5. **`hpet_handle_interrupts_tim1()`** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –æ—Ç hpet1
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏–≥–Ω–∞–ª EOI –¥–ª—è IRQ_CLOCK —á–µ—Ä–µ–∑ `pic_send_eoi(IRQ_CLOCK)`

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å IDT –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π:**

1. **–í `trap_init()`** (—Ñ–∞–π–ª `kern/trap.c`):
   - –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –¥–ª—è IRQ_TIMER:
     ```c
     extern void timer_thdlr(void);
     idt[IRQ_OFFSET + IRQ_TIMER] = GATE(0, GD_KT, timer_thdlr, 0);
     ```
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ `timer_thdlr` —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ `kern/trapentry.S`

2. **–í `trap_dispatch()`** (—Ñ–∞–π–ª `kern/trap.c`):
   - –ó–∞–º–µ–Ω–∏—Ç—å –ø—Ä—è–º—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π RTC –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ —Ç–∞–π–º–µ—Ä–∞:
     ```c
     case IRQ_OFFSET + IRQ_TIMER:
     case IRQ_OFFSET + IRQ_CLOCK:
         timer_for_schedule->handle_interrupts();
         sched_yield();
         return;
     ```
   - –û–±–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (IRQ_TIMER –∏ IRQ_CLOCK) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

- LegacyReplacement —Ä–µ–∂–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è: hpet0 ‚Üí IRQ0 (IRQ_TIMER), hpet1 ‚Üí IRQ8 (IRQ_CLOCK)
- –ì–ª–∞–≤–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π —Ç–∞–π–º–µ—Ä–æ–≤ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –≥–æ–Ω–∫–∏
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∏—Ç–∞ HPET_TN_VAL_SET_CNF –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞—Ä–∞—Ç–æ—Ä–∞

---

## –ó–∞–¥–∞–Ω–∏–µ ‚Ññ3: –í—ã–±–æ—Ä —Ç–∞–π–º–µ—Ä–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

### –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

–°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤—ã–±–æ—Ä —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–¥–∞—á. –í –º–∞—Å—Å–∏–≤–µ `timertab` —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–π–º–µ—Ä—ã (rtc, pit, pm, hpet0, hpet1), –∞ —Ñ—É–Ω–∫—Ü–∏—è `timers_schedule` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∞–π–º–µ—Ä –ø–æ –∏–º–µ–Ω–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ.

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª—ã:** `kern/init.c`, `kern/timer.c`, `kern/timer.h`

**–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **`timers_init()`** ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Ç–∞–π–º–µ—Ä–æ–≤
   - –ó–∞–ø–æ–ª–Ω—è–µ—Ç –º–∞—Å—Å–∏–≤ `timertab` —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ —Ç–∞–π–º–µ—Ä–æ–≤:
     ```c
     timertab[0] = timer_rtc;
     timertab[1] = timer_pit;
     timertab[2] = timer_acpipm;
     timertab[3] = timer_hpet0;
     timertab[4] = timer_hpet1;
     ```
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `timer_init()` (–µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞) –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

2. **`timers_schedule(const char *name)`** ‚Äî –≤—ã–±–æ—Ä —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
   - –ò—â–µ—Ç —Ç–∞–π–º–µ—Ä –≤ –º–∞—Å—Å–∏–≤–µ `timertab` –ø–æ –∏–º–µ–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "rtc", "hpet0", "hpet1")
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —É —Ç–∞–π–º–µ—Ä–∞ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è `enable_interrupts` (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π)
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å `timer_for_schedule` –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–π–º–µ—Ä
   - –í—ã–∑—ã–≤–∞–µ—Ç `enable_interrupts()` –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ `i386_init()`:**

- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `timers_init()` –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö —Ç–∞–π–º–µ—Ä–æ–≤
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `timers_schedule("hpet0")` (–∏–ª–∏ –¥—Ä—É–≥–æ–π —Ç–∞–π–º–µ—Ä) –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∞–π–º–µ—Ä–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º–∏ —Ç–∞–π–º–µ—Ä–∞–º–∏:
- `rtc` ‚Äî —Ç–∞–π–º–µ—Ä RTC (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ)
- `hpet0` ‚Äî HPET —Ç–∞–π–º–µ—Ä 0 —Å –ø–µ—Ä–∏–æ–¥–æ–º 0.5 —Å–µ–∫—É–Ω–¥—ã
- `hpet1` ‚Äî HPET —Ç–∞–π–º–µ—Ä 1 —Å –ø–µ—Ä–∏–æ–¥–æ–º 1.5 —Å–µ–∫—É–Ω–¥—ã

---

## –ó–∞–¥–∞–Ω–∏–µ ‚Ññ4: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞ (spinlock –≤ alloc.c)

### –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

–ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Å –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ –æ–±–ª–∞—Å—Ç—å—é –ø–∞–º—è—Ç–∏ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–æ–Ω–∫–∏ (race conditions). –í —Å–ª—É—á–∞–µ —Å –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–æ–º –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –µ–≥–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—é. –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ç–∞–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–∏–Ω–ª–æ–∫–∏ (spinlocks) ‚Äî –ø—Ä–∏–º–∏—Ç–∏–≤—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º –æ–∂–∏–¥–∞–Ω–∏–µ–º.

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª—ã:** `kern/alloc.c`, `kern/spinlock.c`, `kern/spinlock.h`

**–®–∞–≥–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏–Ω–ª–æ–∫–∞:**
   - –û–±—ä—è–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å–ø–∏–Ω–ª–æ–∫–∞: `static struct spinlock alloc_lock;`
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏–Ω–ª–æ–∫ (–æ–±—ã—á–Ω–æ —á–µ—Ä–µ–∑ –º–∞–∫—Ä–æ—Å `spin_initlock` –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é `__spin_initlock`)

2. **–ó–∞—â–∏—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏ `test_alloc()`:**
   - –í –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–∑–≤–∞—Ç—å `spin_lock(&alloc_lock)` –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
   - –í –∫–æ–Ω—Ü–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ø–µ—Ä–µ–¥ –≤—Å–µ–º–∏ —Ç–æ—á–∫–∞–º–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞) –≤—ã–∑–≤–∞—Ç—å `spin_unlock(&alloc_lock)` –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
   - –í–∞–∂–Ω–æ: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–Ω—è—Ç–∞ –≤–æ –≤—Å–µ—Ö –ø—É—Ç—è—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ (–≤–∫–ª—é—á–∞—è —Ä–∞–Ω–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç—ã)

3. **–ó–∞—â–∏—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏ `test_free()`:**
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `test_alloc()`, –æ–±–µ—Ä–Ω—É—Ç—å –≤—Å—é –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å–æ —Å–ø–∏—Å–∫–æ–º —Å–≤–æ–±–æ–¥–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –≤ `spin_lock`/`spin_unlock`

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

- –°–ø–∏–Ω–ª–æ–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ (busy-waiting), –ø–æ—ç—Ç–æ–º—É –Ω–µ –¥–æ–ª–∂–Ω—ã —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è –¥–æ–ª–≥–æ
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–Ω—è—Ç–∞ –≤–æ –≤—Å–µ—Ö –ø—É—Ç—è—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –∏–Ω–∞—á–µ –≤–æ–∑–º–æ–∂–µ–Ω deadlock
- –û—à–∏–±–∫–∞ "Corrupted list" –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –ø—Ä–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏ —Å–≤—è–∑–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∏–∑-–∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–æ–Ω–∫–∏
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ —Ç–∞–π–º–µ—Ä–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è race condition

---

## –ó–∞–¥–∞–Ω–∏–µ ‚Ññ5: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã CPU –ø–æ HPET –∏ ACPI PMTimer

### –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ TSC –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–Ω–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞. –ß–∞—Å—Ç–æ—Ç—É –º–æ–∂–Ω–æ –≤—ã—á–∏—Å–ª–∏—Ç—å, —Å—Ä–∞–≤–Ω–∏–≤ –¥–µ–ª—å—Ç—É —Å—á–µ—Ç—á–∏–∫–∞ TSC —Å –¥–µ–ª—å—Ç–æ–π –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞ (HPET –∏–ª–∏ ACPI Power Management Timer). HPET –∏–º–µ–µ—Ç –∏–∑–≤–µ—Å—Ç–Ω—É—é —á–∞—Å—Ç–æ—Ç—É, –∫–æ—Ç–æ—Ä–∞—è –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞ GCAP_ID, –∞ ACPI PMTimer —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —á–∞—Å—Ç–æ—Ç–µ 3.579545 MHz.

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª—ã:** `kern/timer.c`, `kern/timer.h`

**–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **`hpet_cpu_frequency()`** ‚Äî –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã CPU —Å –ø–æ–º–æ—â—å—é HPET
   - –í—ã–∑—ã–≤–∞–µ—Ç `hpet_init()` –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ HPET (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç –∏—Ö (`cli`) –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –∏–∑–º–µ—Ä–µ–Ω–∏–π
   - –ß–∏—Ç–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞ HPET: `c1 = hpetReg->MAIN_CNT`
   - –ß–∏—Ç–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ TSC: `t1 = read_tsc()`
   - –ñ–¥–µ—Ç, –ø–æ–∫–∞ –ø—Ä–æ–π–¥–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1/10 —Å–µ–∫—É–Ω–¥—ã): `threshold = hpetFreq / 10`
   - –í —Ü–∏–∫–ª–µ —á–∏—Ç–∞–µ—Ç `MAIN_CNT` –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ —Ä–∞–∑–Ω–∏—Ü–∞ –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç threshold
   - –ß–∏—Ç–∞–µ—Ç –∫–æ–Ω–µ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ TSC: `t2 = read_tsc()`
   - –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π (`sti`, –µ—Å–ª–∏ –±—ã–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã)
   - –í—ã—á–∏—Å–ª—è–µ—Ç —á–∞—Å—Ç–æ—Ç—É: `cpu_freq = (tsc_delta * hpetFreq) / timer_delta`
   - –ö—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –≤—ã–∑–æ–≤–æ–≤

2. **`pmtimer_cpu_frequency()`** ‚Äî –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã CPU —Å –ø–æ–º–æ—â—å—é ACPI PMTimer
   - –ü–æ–ª—É—á–∞–µ—Ç FADT —á–µ—Ä–µ–∑ `get_fadt()` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥—Ä–µ—Å—É PMTimerBlock
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç –∏—Ö
   - –ß–∏—Ç–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ PMTimer: `t1 = pmtimer_get_timeval()` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç `inl(fadt->PMTimerBlock)`)
   - –ß–∏—Ç–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ TSC: `tsc1 = read_tsc()`
   - –î–µ–ª–∞–µ—Ç –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É (`pause` –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)
   - –ß–∏—Ç–∞–µ—Ç –∫–æ–Ω–µ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: `t2 = pmtimer_get_timeval()`, `tsc2 = read_tsc()`
   - –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ PMTimer:
     - –ï—Å–ª–∏ `t2 > t1`: –Ω–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è, `timer_delta = t2 - t1`
     - –ï—Å–ª–∏ `t1 - t2 <= 0x00FFFFFF`: –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ 24-–±–∏—Ç–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞, `timer_delta = 0x00FFFFFF - t1 + t2`
     - –ò–Ω–∞—á–µ: –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ 32-–±–∏—Ç–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞, `timer_delta = UINT32_MAX - t1 + t2`
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ TSC (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
   - –í—ã—á–∏—Å–ª—è–µ—Ç —á–∞—Å—Ç–æ—Ç—É: `cpu_freq = (tsc_delta * PM_FREQ) / timer_delta`, –≥–¥–µ `PM_FREQ = 3579545` (3.579545 MHz)
   - –ö—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

- –ò–∑–º–µ—Ä–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏ (–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã) –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
- PMTimer –º–æ–∂–µ—Ç –±—ã—Ç—å 24-–±–∏—Ç–Ω—ã–º –∏–ª–∏ 32-–±–∏—Ç–Ω—ã–º, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
- TSC —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω—è—Ç—å—Å—è (—Ö–æ—Ç—è —ç—Ç–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ –¥–ª—è 64-–±–∏—Ç–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞)
- –ß–µ–º –±–æ–ª—å—à–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –∏–∑–º–µ—Ä–µ–Ω–∏—è, —Ç–µ–º —Ç–æ—á–Ω–µ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

---

## –ó–∞–¥–∞–Ω–∏–µ ‚Ññ6: –°–µ–∫—É–Ω–¥–æ–º–µ—Ä –Ω–∞ TSC –∏ –∫–æ–º–∞–Ω–¥—ã –º–æ–Ω–∏—Ç–æ—Ä–∞

### –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ TSC (Time Stamp Counter) ‚Äî 64-–±–∏—Ç–Ω–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç —á–∏—Å–ª–æ —Ç–∞–∫—Ç–æ–≤ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞. –ó–Ω–∞—è —á–∞—Å—Ç–æ—Ç—É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–∫—Ç–æ–≤ –º–µ–∂–¥—É –¥–≤—É–º—è –º–æ–º–µ–Ω—Ç–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏, –º–æ–∂–Ω–æ –≤—ã—á–∏—Å–ª–∏—Ç—å –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è. –¢–∞–∫–∂–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ –º–æ–Ω–∏—Ç–æ—Ä –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª—ã:** `kern/tsc.c`, `kern/tsc.h`, `kern/monitor.c`, `kern/init.c`

**–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **`timer_start(const char *name)`** ‚Äî –∑–∞–ø—É—Å–∫ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–∞
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–º—è —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã CPU ("pit", "hpet0", "hpet1", "pm")
   - –í—ã–±–∏—Ä–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑–º–µ—Ä–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã:
     - "pit" ‚Üí `tsc_calibrate()` (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞)
     - "hpet0" –∏–ª–∏ "hpet1" ‚Üí `hpet_cpu_frequency()`
     - "pm" ‚Üí `pmtimer_cpu_frequency()`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—É—é —á–∞—Å—Ç–æ—Ç—É –≤ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ TSC —á–µ—Ä–µ–∑ `read_tsc()` –≤ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ `timer_started = true`

2. **`timer_stop()`** ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–∞ –∏ –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä –±—ã–ª –∑–∞–ø—É—â–µ–Ω (`timer_started == true`), –∏–Ω–∞—á–µ –≤—ã–≤–æ–¥–∏—Ç –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ `print_timer_error()`
   - –ß–∏—Ç–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ TSC: `now = read_tsc()`
   - –í—ã—á–∏—Å–ª—è–µ—Ç –¥–µ–ª—å—Ç—É: `delta = now - timer` (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ `now < timer`)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —á–∞—Å—Ç–æ—Ç–∞ –±—ã–ª–∞ –ø–æ–ª—É—á–µ–Ω–∞ (`freq != 0`), –∏–Ω–∞—á–µ –≤—ã–≤–æ–¥–∏—Ç –æ—à–∏–±–∫—É
   - –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö: `seconds = delta / freq`
   - –í—ã–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ `print_time(seconds)`
   - –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥ `timer_started = false`

3. **`timer_cpu_frequency(const char *name)`** ‚Äî –≤—ã–≤–æ–¥ —á–∞—Å—Ç–æ—Ç—ã CPU –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–º—è —Ç–∞–π–º–µ—Ä–∞
   - –í—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑–º–µ—Ä–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `timer_start`)
   - –í—ã–≤–æ–¥–∏—Ç —á–∞—Å—Ç–æ—Ç—É –≤ –ì–µ—Ä—Ü–∞—Ö —á–µ—Ä–µ–∑ `print_time(freq)`

**–ö–æ–º–∞–Ω–¥—ã –º–æ–Ω–∏—Ç–æ—Ä–∞:**

–í —Ñ–∞–π–ª–µ `kern/monitor.c` –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥:

1. **`mon_start(int argc, char **argv, struct Trapframe *tf)`** ‚Äî –∫–æ–º–∞–Ω–¥–∞ `timer_start`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ (–∏–º—è —Ç–∞–π–º–µ—Ä–∞)
   - –í—ã–∑—ã–≤–∞–µ—Ç `timer_start(argv[1])`

2. **`mon_stop(int argc, char **argv, struct Trapframe *tf)`** ‚Äî –∫–æ–º–∞–Ω–¥–∞ `timer_stop`
   - –í—ã–∑—ã–≤–∞–µ—Ç `timer_stop()`

3. **`mon_frequency(int argc, char **argv, struct Trapframe *tf)`** ‚Äî –∫–æ–º–∞–Ω–¥–∞ `timer_freq`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞
   - –í—ã–∑—ã–≤–∞–µ—Ç `timer_cpu_frequency(argv[1])`

–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ –º–∞—Å—Å–∏–≤–µ `commands`:
```c
{ "timer_start", "Start timer with specified timer name", mon_start },
{ "timer_stop", "Stop timer and print elapsed time", mon_stop },
{ "timer_freq", "Print CPU frequency for specified timer", mon_frequency },
```

**–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º:**

–í —Ñ–∞–π–ª–µ `kern/init.c` –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `i386_init()` –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –≤—ã–∑–æ–≤—ã `ENV_CREATE` –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –≤—ã–ø–æ–ª–Ω—è—é—â–∏—Ö—Å—è –ø—Ä–æ–≥—Ä–∞–º–º, —á—Ç–æ–±—ã —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–ª–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

- TSC –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è (–∫—Ä–æ–º–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è 64-–±–∏—Ç–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞)
- –ß–∞—Å—Ç–æ—Ç–∞ CPU –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∞ –¥–æ –∑–∞–ø—É—Å–∫–∞ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è TSC –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏—è—Ö
- –ö–æ–º–∞–Ω–¥—ã –º–æ–Ω–∏—Ç–æ—Ä–∞ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

---

## –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–±–µ–¥–∏—Ç—å—Å—è:

1. ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–∞–π–º–µ—Ä–∞–º–∏ rtc, hpet0, hpet1
2. ‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã —Å –∑–∞–¥–∞–Ω–Ω–æ–π —á–∞—Å—Ç–æ—Ç–æ–π
3. ‚úÖ –ê–ª–ª–æ–∫–∞—Ç–æ—Ä –ø–∞–º—è—Ç–∏ –∑–∞—â–∏—â–µ–Ω –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π –≥–æ–Ω–∫–∏ (–Ω–µ—Ç –æ—à–∏–±–æ–∫ "Corrupted list")
4. ‚úÖ –°–µ–∫—É–Ω–¥–æ–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è —Å –ø–æ–º–æ—â—å—é —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤
5. ‚úÖ –ö–æ–º–∞–Ω–¥—ã –º–æ–Ω–∏—Ç–æ—Ä–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í VirtualBox –∫–æ–¥ –ø–æ–¥—Å—á–µ—Ç–∞ —á–∞—Å—Ç–æ—Ç—ã —Å PIT –º–æ–∂–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –≤ `tsc_calibrate()`), –≤ —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ç–∞–π–º–µ—Ä—ã (hpet0, hpet1, pm)
- –ü—Ä–∏ —É–º–µ–Ω—å—à–µ–Ω–∏–∏ –ø–µ—Ä–∏–æ–¥–∞ —Ç–∞–π–º–µ—Ä–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è race conditions, —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã—è–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å ACPI —Ç–∞–±–ª–∏—Ü–∞–º–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

